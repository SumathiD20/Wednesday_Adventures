name: OWASP Security Scan

on:
  push:
    branches:
      - main
      - develop
      - l00187927-WA-Jira18-CIPipeline  
  pull_request:
    branches:
      - main
      - develop
      - l00187927-WA-Jira18-CIPipeline
 
jobs:
  security-scan:
    runs-on: ubuntu-latest
 
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # ------------------------------
    # OWASP Dependency-Check (SCA)
    # ------------------------------
    - name: Run OWASP Dependency-Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: "Wednesday_Adventures"
        path: "./"
        format: "ALL"
        out: "./dependency-check-report"

    - name: Upload Dependency-Check Report
      uses: actions/upload-artifact@v4
      with:
        name: dependency-check-report
        path: dependency-check-report

    # ------------------------------
    # SonarQube Static Code Scan (SAST)
    # ------------------------------
    - name: Set up SonarQube
      uses: SonarSource/sonarcloud-github-action@v1
      with:
        entryPoint: "sonar-scanner"
        args: |
          -Dsonar.projectKey=your_project_key
          -Dsonar.organization=your_organization
          -Dsonar.host.url=https://sonarcloud.io
        projectBaseDir: .

    - name: Run SonarQube Analysis
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}  # This sets the SONAR_TOKEN as an environment variable
      run: |
        sonar-scanner \
          -Dsonar.projectKey=your_project_key \
          -Dsonar.organization=your_organization \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}

    - name: Upload SonarQube Report
      uses: actions/upload-artifact@v4
      with:
        name: sonar-report
        path: sonar-report

    # ------------------------------
    # Fail Build on Critical/High Vulnerabilities
    # ------------------------------
    - name: Fail Build on Critical/High Vulnerabilities
      run: |
        if [ ! -s dependency-check-report/dependency-check-report.json ]; then
          echo "‚ö†Ô∏è No dependency-check report found. Skipping failure check."
          exit 0
        fi

        # Count vulnerabilities by severity
        CRITICAL_COUNT=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity=="Critical")] | length' dependency-check-report/dependency-check-report.json)
        HIGH_COUNT=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity=="High")] | length' dependency-check-report/dependency-check-report.json)

        echo "üîç Found vulnerabilities:"
        echo "   üî¥ Critical: $CRITICAL_COUNT"
        echo "   üü† High: $HIGH_COUNT"

        if [ "$CRITICAL_COUNT" -gt 0 ]; then
          echo "‚ùå Critical vulnerabilities found! Failing the build."
          exit 1
        fi

        if [ "$HIGH_COUNT" -gt 5 ]; then
          echo "‚ùå More than 5 High vulnerabilities found! Failing the build."
          exit 1
        fi

        echo "‚úÖ No critical or excessive high vulnerabilities found. Proceeding..."
